<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Documentation</title>
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">

    <link href="../stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
      <script src="../javascripts/all_nosearch.js" type="text/javascript"></script>

  </head>

  <body class="includes includes_callbacks">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="../images/whispir.io_Logo_Negative.png" />
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="callbacks">Callbacks</h1>

<p>Whispir utilises API Callbacks to send simple notifications to different registered services in the event that some change has occurred on the Whispir Platform.</p>

<h2 id="what-are-callbacks?">What are Callbacks?</h2>

<blockquote>
<p>What are Callbacks?</p>

<blockquote>
<p>Whispir can notify your application when your SMS, Email or Voice messages receive a reply.
<br/><br/>
An example callback that your application or service would receive is specified below.</p>
</blockquote>
</blockquote>
<pre><code class="highlight xml">HTTP 1.1 POST http://yourserver/callback.php
Content-Type: application/xml

<span class="nt">&lt;ns2:deliveryresponse</span> <span class="na">xmlns:ns2=</span><span class="s">"http://schemas.api.whispir.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;messageid&gt;</span>ABC4857BCCF484575FCA<span class="nt">&lt;/messageid&gt;</span>
    <span class="nt">&lt;location&gt;</span>https://api.whispir.com/messages/ABC4857BCCF484575FCA<span class="nt">&lt;/location&gt;</span>   
    <span class="nt">&lt;from&gt;</span>
        <span class="nt">&lt;name&gt;</span>Fred Waters<span class="nt">&lt;/name&gt;</span> 
        <span class="nt">&lt;mri&gt;</span>Fred_Waters.528798.Sandbox@Contact.whispir.com<span class="nt">&lt;/mri&gt;</span> 
        <span class="nt">&lt;mobile&gt;</span>0430984567<span class="nt">&lt;/mobile&gt;</span> 
        <span class="nt">&lt;email&gt;</span>imacros@test.com<span class="nt">&lt;/email&gt;</span> 
        <span class="nt">&lt;voice&gt;</span>0761881564<span class="nt">&lt;/voice&gt;</span> 
    <span class="nt">&lt;/from&gt;</span> 
    <span class="nt">&lt;responsemessage&gt;</span> 
        <span class="nt">&lt;channel&gt;</span>SMS<span class="nt">&lt;/channel&gt;</span> 
        <span class="nt">&lt;acknowledged&gt;</span>09/01/13 13:22<span class="nt">&lt;/acknowledged&gt;</span> 
        <span class="nt">&lt;content&gt;</span>Yes, I accept. Will I need to bring steel cap boots?<span class="nt">&lt;/content&gt;</span> 
    <span class="nt">&lt;/responsemessage&gt;</span> 
<span class="nt">&lt;/ns2:deliveryresponse&gt;</span>
</code></pre>
<pre><code class="highlight go"><span class="n">HTTP</span><span class="x"> </span><span class="m">1.1</span><span class="x"> </span><span class="n">POST</span><span class="x"> </span><span class="n">http</span><span class="o">:</span><span class="c">//yourserver/callback.php</span><span class="x">
</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="x">
</span><span class="p">{</span><span class="x">
    </span><span class="s">"messageId"</span><span class="o">:</span><span class="s">"ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
    </span><span class="s">"location"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"https://api.whispir.com/messages/ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
    </span><span class="s">"from"</span><span class="o">:</span><span class="p">{</span><span class="x">
          </span><span class="s">"name"</span><span class="o">:</span><span class="s">"Fred Waters"</span><span class="p">,</span><span class="x">
          </span><span class="s">"mri"</span><span class="o">:</span><span class="s">"Fred_Waters.528798.Sandbox@Contact.whispir.com"</span><span class="p">,</span><span class="x">
          </span><span class="s">"mobile"</span><span class="o">:</span><span class="s">"0430984567"</span><span class="p">,</span><span class="x">
          </span><span class="s">"email"</span><span class="o">:</span><span class="s">"imacros@test.com"</span><span class="p">,</span><span class="x">
          </span><span class="s">"voice"</span><span class="o">:</span><span class="s">"0761881564"</span><span class="x">
         </span><span class="p">},</span><span class="x">
    </span><span class="s">"responseMessage"</span><span class="o">:</span><span class="p">{</span><span class="x">
           </span><span class="s">"channel"</span><span class="o">:</span><span class="s">"SMS"</span><span class="p">,</span><span class="x">
           </span><span class="s">"acknowledged"</span><span class="o">:</span><span class="s">"09/01/13 13:22"</span><span class="p">,</span><span class="x">
           </span><span class="s">"content"</span><span class="o">:</span><span class="s">"Yes, I accept. Will I need to bring steel cap boots?"</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>

<p>Callbacks allow custom applications to register URLs with Whispir that are used for notifications when certain events occur e.g. a response to a message is received, or a message was undeliverable.</p>

<p><br/><img src="http://developer.whispir.com/files/Whispir_API_diagram.png"/><br/></p>

<p>Whispir&rsquo;s Callback Service will forward the content of each message response, along with some associated metadata to a URL that the user has pre-registered to receive this information.  </p>

<p><strong>Note:</strong> Whispir does not check for a response from this callback server.  On setup it is expected that the server will respond to a GET request with a 200 OK.  Any error response sent from this callback server during general use is not considered.  Users should not expect callbacks to be re-tried on error.</p>

<h2 id="creating-new-callbacks">Creating new Callbacks</h2>

<blockquote>
<p>Creating new Callbacks</p>

<blockquote>
<p>The following API calls allow users to create new Callbacks using the Whispir API.</p>
</blockquote>
</blockquote>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://api.whispir.com/callbacks?apikey=&lt;yourkey&gt;
Authorization: Basic am9obi5zbWl0aDpteXBhc3N3b3Jk
</code></pre>
<pre><code class="highlight xml">Content-Type: application/vnd.whispir.api-callback-v1+xml

<span class="cp">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;</span>
<span class="nt">&lt;ns2:companyapicallback</span> <span class="na">xmlns:ns2=</span><span class="s">"http://schemas.api.whispir.com"</span> 
                    <span class="na">xmlns:ns3=</span><span class="s">"http://schemas.api.whispir.com/dap"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;name&gt;</span>Callback Name<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;url&gt;</span>http://myserver.com/mycallback.php<span class="nt">&lt;/url&gt;</span>
    <span class="nt">&lt;auth&gt;</span>
        <span class="nt">&lt;key&gt;</span>MY_AUTH_KEY<span class="nt">&lt;/key&gt;</span>
        <span class="nt">&lt;type&gt;</span>querystring<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;/auth&gt;</span>
    <span class="nt">&lt;contentType&gt;</span>json<span class="nt">&lt;/contentType&gt;</span>
    <span class="nt">&lt;email&gt;</span>me@example.com<span class="nt">&lt;/email&gt;</span>
    <span class="nt">&lt;callbacks&gt;</span>
        <span class="nt">&lt;reply&gt;</span>enabled<span class="nt">&lt;/reply&gt;</span>
        <span class="nt">&lt;undeliverable&gt;</span>enabled<span class="nt">&lt;/undeliverable&gt;</span>
    <span class="nt">&lt;/callbacks&gt;</span>
<span class="nt">&lt;/ns2:companyapicallback&gt;</span>
</code></pre>
<pre><code class="highlight go"><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="o">.</span><span class="n">whispir</span><span class="o">.</span><span class="n">api</span><span class="o">-</span><span class="n">callback</span><span class="o">-</span><span class="n">v1</span><span class="o">+</span><span class="n">json</span><span class="x">

</span><span class="p">{</span><span class="x">
  </span><span class="s">"name"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Callback Name"</span><span class="p">,</span><span class="x">
  </span><span class="s">"url"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"http://myserver.com/mycallback.php"</span><span class="p">,</span><span class="x">
  </span><span class="s">"auth"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"type"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"querystring"</span><span class="p">,</span><span class="x">
    </span><span class="s">"key"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"MY_AUTH_KEY"</span><span class="x">
  </span><span class="p">},</span><span class="x">
  </span><span class="s">"contentType"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"json"</span><span class="p">,</span><span class="x">
  </span><span class="s">"email"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"me@example.com"</span><span class="p">,</span><span class="x">
  </span><span class="s">"callbacks"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"reply"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"enabled"</span><span class="p">,</span><span class="x">
    </span><span class="s">"undeliverable"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"enabled"</span><span class="x">
  </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>

<blockquote>
<blockquote>
<p>The sample code above will create a callback endpoint that can be used within messages being sent from Whispir.<br/><br/>
The expected response to this call is an <strong>HTTP 201 - Created</strong>.</p>
</blockquote>
</blockquote>

<p>To create a new API Callback, you can use the <code class="prettyprint">/callbacks</code> endpoint.</p>

<p>The following table describes the fields that can be used within the request.</p>

<table>
    <thead>
        <tr>
            <th style="width: 50%" colspan="2">High-Level Request Elements</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="text-align: right; font-weight: bold;">name:</td>
            <td><strong>String</strong><br/>
                Specifies the name (ID) of the callback to be used within message requests.
            </td>
        </tr>
        <tr>
            <td style="text-align: right; font-weight: bold;">url:</td>
            <td><strong>String</strong><br/>
                Specifies the service URL that API Callbacks should be forwarded to.
            </td>
        </tr>
        <tr>
            <td style="text-align: right; font-weight: bold;">auth:</td>
            <td><strong>Object</strong><br/>
                Specifies the Authorization type that should be used with this endpoint.  The specific elements of this object are described below.<br/><br/>
                The options for this parameter are:
                <ul>
                  <li>querystring</li>
                  <li>httpheader</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td style="text-align: right; font-weight: bold;">contentType:</td>
            <td><strong>String</strong><br/>
                Specifies the content type that should be sent to this endpoint.<br/><br/>
                The choices are as follows:
                <ul>
                  <li>json</li>
                  <li>xml</li>
                </ul>
            </td>
        </tr>
        <tr>
            <td style="text-align: right; font-weight: bold;">email:</td>
            <td><strong>String</strong><br/>
                Specifies the email address where failure notifications should be sent.
            </td>
        </tr>
        <tr>
            <td style="text-align: right; font-weight: bold;">callbacks:</td>
            <td><strong>Object</strong><br/>
                Object to store the callbacks that should be invoked for this endpoint.  The specific elements of this object are described below. 
            </td>
        </tr>
    </tbody>
</table>

<h3 id="callback-authorization">Callback Authorization</h3>

<blockquote>
<p>Callback Authorization</p>

<blockquote>
<p>Callback Servers should validate that the inbound request they are receiving is actually coming from Whispir.<br/><br/>
Callbacks can be authorized using one of two methods: <strong>HTTP Header</strong>, or <strong>URL Query Parameter</strong></p>

<p><strong>HTTP Header Auth Token</strong>
<br/>Users can specify their Authorization token as an HTTP Header. Whispir will add the <strong>X-Whispir-Callback-Key</strong> Header to the request.</p>
</blockquote>
</blockquote>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://yourserver/callback.php
X-Whispir-Callback-Key: MY_AUTH_TOKEN 
</code></pre>
<pre><code class="highlight xml">Content-Type: application/xml

<span class="nt">&lt;ns2:deliveryresponse</span> <span class="na">xmlns:ns2=</span><span class="s">"https://schemas.api.whispir.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;messageid&gt;</span>ABC4857BCCF484575FCA<span class="nt">&lt;/messageid&gt;</span>
    <span class="nt">&lt;location&gt;</span>https://api.whispir.com/messages/ABC4857BCCF484575FCA<span class="nt">&lt;/location&gt;</span>   
    <span class="nt">&lt;from&gt;</span>
        <span class="nt">&lt;name&gt;</span>Fred Waters<span class="nt">&lt;/name&gt;</span> 
        <span class="nt">&lt;mri&gt;</span>Fred_Waters.528798.Sandbox@Contact.whispir.com<span class="nt">&lt;/mri&gt;</span> 
        <span class="nt">&lt;mobile&gt;</span>0430984567<span class="nt">&lt;/mobile&gt;</span> 
        <span class="nt">&lt;email&gt;</span>imacros@test.com<span class="nt">&lt;/email&gt;</span> 
        <span class="nt">&lt;voice&gt;</span>0761881564<span class="nt">&lt;/voice&gt;</span> 
    <span class="nt">&lt;/from&gt;</span> 
    <span class="nt">&lt;responsemessage&gt;</span> 
        <span class="nt">&lt;channel&gt;</span>SMS<span class="nt">&lt;/channel&gt;</span> 
        <span class="nt">&lt;acknowledged&gt;</span>09/01/13 13:22<span class="nt">&lt;/acknowledged&gt;</span> 
        <span class="nt">&lt;content&gt;</span>Yes, I accept. Will I need to bring steel cap boots?<span class="nt">&lt;/content&gt;</span> 
    <span class="nt">&lt;/responsemessage&gt;</span> 
<span class="nt">&lt;/ns2:deliveryresponse&gt;</span>
</code></pre>
<pre><code class="highlight go"><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="x">

</span><span class="p">{</span><span class="x">
  </span><span class="s">"messageid"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
  </span><span class="s">"location"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"https://api.whispir.com/messages/ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
  </span><span class="s">"from"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"name"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Fred Waters"</span><span class="p">,</span><span class="x">
    </span><span class="s">"mri"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Fred_Waters.528798.Sandbox@Contact.whispir.com"</span><span class="p">,</span><span class="x">
    </span><span class="s">"mobile"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"$mobile"</span><span class="p">,</span><span class="x">
    </span><span class="s">"email"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"me@example.com"</span><span class="p">,</span><span class="x">
    </span><span class="s">"voice"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"$mobile"</span><span class="x">
  </span><span class="p">},</span><span class="x">
  </span><span class="s">"responseMessage"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"channel"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"SMS"</span><span class="p">,</span><span class="x">
    </span><span class="s">"acknowledged"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"09/01/13 13:22"</span><span class="p">,</span><span class="x">
    </span><span class="s">"content"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Yes, I accept. Will I need to bring steel cap boots?"</span><span class="x">
  </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>

<blockquote>
<blockquote>
<p><strong>URL Query Parameter Auth Token</strong>
<br/>Users can specify their Authorization token as a URL query parameter.  This will come as <strong><code class="prettyprint">auth=:your_token</code></strong> on the URL.</p>
</blockquote>
</blockquote>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://yourserver/callback.php?auth=MY_AUTH_TOKEN
</code></pre>
<pre><code class="highlight xml">Content-Type: application/xml

<span class="nt">&lt;ns2:deliveryresponse</span> <span class="na">xmlns:ns2=</span><span class="s">"https://schemas.api.whispir.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;messageid&gt;</span>ABC4857BCCF484575FCA<span class="nt">&lt;/messageid&gt;</span>
    <span class="nt">&lt;location&gt;</span>https://api.whispir.com/messages/ABC4857BCCF484575FCA<span class="nt">&lt;/location&gt;</span>   
    <span class="nt">&lt;from&gt;</span>
        <span class="nt">&lt;name&gt;</span>Fred Waters<span class="nt">&lt;/name&gt;</span> 
        <span class="nt">&lt;mri&gt;</span>Fred_Waters.528798.Sandbox@Contact.whispir.com<span class="nt">&lt;/mri&gt;</span> 
        <span class="nt">&lt;mobile&gt;</span>0430984567<span class="nt">&lt;/mobile&gt;</span> 
        <span class="nt">&lt;email&gt;</span>imacros@test.com<span class="nt">&lt;/email&gt;</span> 
        <span class="nt">&lt;voice&gt;</span>0761881564<span class="nt">&lt;/voice&gt;</span> 
    <span class="nt">&lt;/from&gt;</span> 
    <span class="nt">&lt;responsemessage&gt;</span> 
        <span class="nt">&lt;channel&gt;</span>SMS<span class="nt">&lt;/channel&gt;</span> 
        <span class="nt">&lt;acknowledged&gt;</span>09/01/13 13:22<span class="nt">&lt;/acknowledged&gt;</span> 
        <span class="nt">&lt;content&gt;</span>Yes, I accept. Will I need to bring steel cap boots?<span class="nt">&lt;/content&gt;</span> 
    <span class="nt">&lt;/responsemessage&gt;</span> 
<span class="nt">&lt;/ns2:deliveryresponse&gt;</span>
</code></pre>
<pre><code class="highlight go"><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="x">

</span><span class="p">{</span><span class="x">
  </span><span class="s">"messageid"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
  </span><span class="s">"location"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"https://api.whispir.com/messages/ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
  </span><span class="s">"from"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"name"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Fred Waters"</span><span class="p">,</span><span class="x">
    </span><span class="s">"mri"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Fred_Waters.528798.Sandbox@Contact.whispir.com"</span><span class="p">,</span><span class="x">
    </span><span class="s">"mobile"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"$mobile"</span><span class="p">,</span><span class="x">
    </span><span class="s">"email"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"me@example.com"</span><span class="p">,</span><span class="x">
    </span><span class="s">"voice"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"$mobile"</span><span class="x">
  </span><span class="p">},</span><span class="x">
  </span><span class="s">"responseMessage"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="s">"channel"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"SMS"</span><span class="p">,</span><span class="x">
    </span><span class="s">"acknowledged"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"09/01/13 13:22"</span><span class="p">,</span><span class="x">
    </span><span class="s">"content"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"Yes, I accept. Will I need to bring steel cap boots?"</span><span class="x">
  </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>

<p>Whispir Callbacks have been designed to be simple, yet secure.<br>
In order to make your Callback Server processing much safer, whispir recommends the following </p>

<ul>
<li>Use SSL on your Callback URL</li>
<li>IP Whitelisting for Whispir&rsquo;s IP address</li>
<li>Use a unique token</li>
</ul>

<p>The unique token can/should be an alphanumeric/numeric token generated and assigned specifically foWhispir Callback pur rpose. When provided in the callback settings, Whipir shall include this in every request made to the listening application. The token&rsquo;s presence ensures and confirms that the request has originated truly from Whispir.</p>

<p>There are two options for the Authorization Token:</p>

<h4 id="http-header">HTTP Header</h4>

<p>Using an HTTP Header for authorisation is the preferred approach. This method will use a custom HTTP Header <strong>X-Whispir-Callback-Key</strong>.</p>

<p>This can be added to the callback by specifying the code block:</p>

<p><code class="prettyprint">&quot;auth&quot; : { &quot;type&quot; : &quot;httpheader&quot;, &quot;key&quot; : &quot;MY_AUTH_TOKEN&quot; }</code></p>

<p>Every request to the specified URL will include the supplied AUTH Token within this Header.  Alternatively, this could be supplied as a query parameter as follows.</p>

<h4 id="url-query-parameter">URL Query Parameter</h4>

<p>In this method, the Authorization will be passed to the callback server on the query string using an &lsquo;Auth&rsquo; parameter as follows:</p>

<p><code class="prettyprint">&quot;auth&quot; : { &quot;type&quot; : &quot;querystring&quot;, &quot;key&quot; : &quot;MY_AUTH_TOKEN&quot; }</code></p>

<h3 id="callback-types">Callback Types</h3>

<p>Callbacks can be added to any message that is sent from the Whispir API using the <code class="prettyprint">/messages</code> endpoint.</p>

<p>Each callback can be invoked from one of two actions occurring:</p>

<ul>
<li>A message has been replied to, or</li>
<li>A message delivery failure occurred</li>
</ul>

<p>Users can control which of these actions are delivered to the endpoint using the <code class="prettyprint">callbacks</code> object when registering new callbacks.</p>

<p>The options that are available are:</p>

<ul>
<li>reply: enabled/disabled</li>
<li>undeliverable: enabled/disabled</li>
</ul>

<p>When these are enabled, any reply or failed delivery will cause a <code class="prettyprint">GET</code> request to be invoked on the URL that was provided.</p>

<h2 id="retrieving-callbacks">Retrieving Callbacks</h2>

<h2 id="updating-callbacks">Updating Callbacks</h2>

<h2 id="deleting-callbacks">Deleting Callbacks</h2>

<h2 id="using-callbacks">Using Callbacks</h2>

<p>With the callback server successfully configured, you can now add the ID of it in your message content whenever you are sending any messages. </p>

<p>The ID is the callback name one has provided while registering the callback URI. Any replies to this message will automatically be forwarded back to the associated server for processing.</p>

<p>The following examples show how you can use your server above to receive responses in JSON.</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://api.whispir.com/messages?apikey=&lt;yourkey&gt;
Authorization: Basic am9obi5zbWl0aDpteXBhc3N3b3Jk
Content-Type: application/vnd.whispir.message-v1+json

{
   "to" : "$mobile",
   "subject" : "Test SMS Message",
   "body" : "This is the body of my test SMS message",
   "callbackId" : "JSON Callback"
}
</code></pre>

<p>XML responses can also be received by changing the Content-Type to XML as shown below –</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://api.whispir.com/messages?apikey=&lt;yourkey&gt;
Authorization: Basic am9obi5zbWl0aDpteXBhc3N3b3Jk
Content-Type: application/vnd.whispir.message-v1+xml

&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;ns2:message xmlns:ns2="https://schemas.api.whispir.com"&gt;
    &lt;to&gt;$mobile&lt;/to&gt;
    &lt;subject&gt;Test SMS Message&lt;/subject&gt;    
    &lt;body&gt;This is the body of my test SMS message&lt;/body&gt;
    &lt;callbackId&gt;JSON Callback&lt;/callbackId&gt;
&lt;/ns2:message&gt; 
</code></pre>

<p>Any responses to the above sent message will be forwarded back to the Callback Server with ID ‘<em>JSON Callback</em>&rsquo; and written to the text file (as shown in the code example above).</p>

<h3 id="adding-authentication-to-your-callback">Adding Authentication to your callback</h3>

<p>The following code example shows how to use the query parameter for authentication -</p>
<pre><code class="highlight php"><span class="cp">&lt;?php</span>
   <span class="cm">/*
    * Author: Jordan Walsh
    * Description: Callback Server that supports JSON POSTs and writes the 
    *              content to a file called responses.txt in the same directory.
    * Updates: 
    *   - Added support for Authentication.
    */</span>        

   <span class="nb">header</span><span class="p">(</span><span class="s2">"HTTP/1.1 200 OK"</span><span class="p">);</span>

   <span class="nv">$text</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
   <span class="nv">$obj</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
   <span class="nv">$query</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
   <span class="nv">$auth</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

   <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'QUERY_STRING'</span><span class="p">];</span>

   <span class="k">if</span><span class="p">(</span> <span class="s2">"</span><span class="nv">$query</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="p">)</span> <span class="p">{</span>

      <span class="c1">//GET the auth variable off the query string
</span>      <span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"auth"</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span> <span class="s2">"</span><span class="nv">$auth</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"234023490349034"</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">writeFile</span><span class="p">(</span><span class="s2">"Authentication failed. Auth = </span><span class="nv">$auth</span><span class="s2">"</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">//Auth is correct so continue processing
</span>
         <span class="c1">//Get the body of the POST Message (the reply)
</span>         <span class="nv">$json</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">'php://input'</span><span class="p">);</span>

         <span class="k">if</span><span class="p">(</span> <span class="nv">$json</span> <span class="o">!=</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">{</span>  
            <span class="c1">//Decode the JSON object
</span>            <span class="nv">$obj</span> <span class="o">=</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">);</span>

            <span class="c1">//Get the ResponseMessage from the JSON object
</span>            <span class="nv">$responseMessage</span> <span class="o">=</span> <span class="nv">$obj</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'responseMessage'</span><span class="p">};</span>

            <span class="c1">//Get the content of the response
</span>            <span class="nv">$text</span> <span class="o">=</span> <span class="nv">$responseMessage</span><span class="o">-&gt;</span><span class="p">{</span><span class="s1">'content'</span><span class="p">};</span>

            <span class="c1">//Write the content to a file
</span>            <span class="nx">writeFile</span><span class="p">(</span><span class="nv">$text</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
           <span class="nx">writeFile</span><span class="p">(</span><span class="s1">'Request received.  JSON object is empty.'</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">writeFile</span><span class="p">(</span><span class="s1">'Callback Received.  Querystring not defined.'</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">function</span> <span class="nf">writeFile</span><span class="p">(</span><span class="nv">$text</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"responses.txt"</span><span class="p">,</span> <span class="nv">$text</span><span class="p">,</span> <span class="nx">FILE_APPEND</span><span class="p">);</span>
   <span class="p">}</span>

<span class="cp">?&gt;</span>

</code></pre>

<p>The code checks for the presence of an &#39;auth&rsquo; parameter in the URL.  Once this is present and correct, the script will be executed further.  If the auth parameter is not present, or it is incorrect, it shall write the error information to the file and end.</p>

<h2 id="callback-failures">Callback Failures</h2>

<p>Whispir provides a feature as part of the callback offering where in if the provided callback URI could not be reached or if Whispir has faced any issues in reaching / passing the information as expected to provided URI, it can notify about it.</p>

<p>The notification will be done via email and the destination is the email provided to the ‘Notify of errors (email)&rsquo; during the callback setup.</p>

<blockquote>
<p>Insert image here highlighting the email field</p>
</blockquote>

<ul>
<li>Whispir will automatically send an email in the following circumstances:</li>
<li>If the Callback Server returns anything other than an HTTP 200 OK.</li>
<li>If the authorization to the Callback Server fails (e.g. returns an HTTP 400 level error) </li>
<li>If the Callback Server does not connect within 5 seconds.</li>
<li>If the Callback Server does not return a response within 60 seconds.</li>
</ul>

<p>In any of these events, Whispir will send an email that resembles the following: - </p>
<pre><code class="highlight plaintext">Dear Customer,  

Your callback &lt;callback_id&gt; failed on &lt;date&gt; with response: &lt;response&gt;.  

The callback that failed is as follows:  

URL: https://yourserver/callback.php?auth=12345 
Location: https://api.whispir.com/messages/ABC4857BCCF484575FCA 
Name: Fred Waters 
Mobile: 0430984567 
Email: imacros@test.com 
Channel: SMS 
Content: Yes, I accept. Will I need to bring steel cap boots? 

Please take the necessary steps to ensure your callback is configured correctly.  

If this callback URL continues to fail, Whispir may remove this until the service is resolved. 

Regards, 
Whispir Support

</code></pre>

<h2 id="enhanced-callbacks">Enhanced Callbacks</h2>
<pre><code class="highlight xml">HTTP 1.1 POST http://myapp.com/statusupdate
Content-Type: application/xml

<span class="nt">&lt;ns2:statuscallback</span> <span class="na">xmlns:ns2=</span><span class="s">"http://schemas.api.whispir.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;messageid&gt;</span>ABC4857BCCF484575FCA<span class="nt">&lt;/messageid&gt;</span> 
    <span class="nt">&lt;from&gt;</span>
        <span class="nt">&lt;name&gt;</span>John Waters<span class="nt">&lt;/name&gt;</span> 
        <span class="nt">&lt;mri&gt;</span>John_Waters.528798.Sandbox@Contact.whispir.com<span class="nt">&lt;/mri&gt;</span> 
        <span class="nt">&lt;mobile&gt;</span>0430984567<span class="nt">&lt;/mobile&gt;</span> 
        <span class="nt">&lt;email&gt;</span>test@test.com<span class="nt">&lt;/email&gt;</span> 
        <span class="nt">&lt;voice&gt;</span>0761881564<span class="nt">&lt;/voice&gt;</span> 
    <span class="nt">&lt;/from&gt;</span> 
    <span class="nt">&lt;oldStatus&gt;</span> 
        <span class="nt">&lt;status&gt;</span>PEND<span class="nt">&lt;/status&gt;</span> <span class="c">&lt;!-- PENDING STATUS --&gt;</span>
        <span class="nt">&lt;timestamp&gt;</span>09/01/13 13:22<span class="nt">&lt;/timestamp&gt;</span> 
    <span class="nt">&lt;/oldStatus&gt;</span>
    <span class="nt">&lt;newStatus&gt;</span> 
        <span class="nt">&lt;status&gt;</span>SENT<span class="nt">&lt;/status&gt;</span> <span class="c">&lt;!-- SENT STATUS --&gt;</span>
        <span class="nt">&lt;timestamp&gt;</span>09/01/13 13:22<span class="nt">&lt;/timestamp&gt;</span> 
    <span class="nt">&lt;/newStatus&gt;</span>  
<span class="nt">&lt;/ns2:statuscallback&gt;</span>
</code></pre>
<pre><code class="highlight go"><span class="n">HTTP</span><span class="x"> </span><span class="m">1.1</span><span class="x"> </span><span class="n">POST</span><span class="x"> </span><span class="n">http</span><span class="o">:</span><span class="c">//myapp.com/statusupdate</span><span class="x">
</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="x">

</span><span class="p">{</span><span class="x">
    </span><span class="s">"messageId"</span><span class="o">:</span><span class="s">"ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
    </span><span class="s">"location"</span><span class="x"> </span><span class="o">:</span><span class="x"> </span><span class="s">"https://api.whispir.com/workspaces/FDD8348CBBED939FCAC/messages/ABC4857BCCF484575FCA"</span><span class="p">,</span><span class="x">
    </span><span class="s">"from"</span><span class="o">:</span><span class="p">{</span><span class="x">
          </span><span class="s">"name"</span><span class="o">:</span><span class="s">"Fred Waters"</span><span class="p">,</span><span class="x">
          </span><span class="s">"mri"</span><span class="o">:</span><span class="s">"Fred_Waters.528798.Sandbox@Contact.whispir.com"</span><span class="p">,</span><span class="x">
          </span><span class="s">"mobile"</span><span class="o">:</span><span class="s">"0430984567"</span><span class="p">,</span><span class="x">
          </span><span class="s">"email"</span><span class="o">:</span><span class="s">"imacros@test.com"</span><span class="p">,</span><span class="x">
          </span><span class="s">"voice"</span><span class="o">:</span><span class="s">"0761881564"</span><span class="x">
         </span><span class="p">},</span><span class="x">
    </span><span class="s">"responseMessage"</span><span class="o">:</span><span class="p">{</span><span class="x">
           </span><span class="s">"channel"</span><span class="o">:</span><span class="s">"SMS"</span><span class="p">,</span><span class="x">
           </span><span class="s">"acknowledged"</span><span class="o">:</span><span class="s">"09/01/13 13:22"</span><span class="p">,</span><span class="x">
           </span><span class="s">"content"</span><span class="o">:</span><span class="s">"Yes, I accept. Will I need to bring steel cap boots?"</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>

<p>Whispir currently supports a callback on Message Response.  It is envisaged that Whispir will implement support for the following callbacks:</p>

<ul>
<li>On Message Status Change </li>
<li>On Report Completion</li>
</ul>

<h4 id="message-status-change">Message status change</h4>

<p>This callback URL will be triggered whenever the message status changes for each recipient on a message.  </p>

<p>For example, if a user sends a message to two recipients; <strong>John</strong> &amp; <strong>Steve</strong>.  In this message, the user has configured the <strong>Message Status Change</strong> callback URL to be: <em>http://myapp.com/statusupdate</em></p>

<p>In this message, <strong>Steve&rsquo;s</strong> mobile number <strong>is incorrect.</strong></p>

<ul>
<li>Callback 1: Status change from <strong>Pending</strong> to <strong>Sent</strong> for John when the message is sent</li>
<li>Callback 2: Status change from <strong>Pending</strong> to <strong>Sent</strong> for Steve when the message is sent</li>
<li>Callback 3: Status change from <strong>Sent</strong> to <strong>Received</strong> for John when the message is received on the handset</li>
<li>Callback 4: Status change from <strong>Sent</strong> to <strong>Undeliverable</strong> for Steve when the processing of the mobile number fails</li>
</ul>

<p>If John was to then reply to the message…</p>

<ul>
<li>Callback 5: Status change from <strong>Received</strong> to <strong>Acknowleged</strong> for John when the reply is received</li>
</ul>

<p><strong>Note:</strong> This may cause a large load on both Whispir and the customer&rsquo;s callback service when large multichannel message sendouts are invoked, as such, the technical implementation details of this callback service are under review.</p>

<h4 id="report-completion">Report Completion</h4>

<p>This callback URL will be triggered whenever a report scheduled through the API has completed the generation process.</p>

<p>For example, when a user creates a report that may take some time to generate (i.e. contains years of data), this callback can be utilised to advise an application that the report is ready to be downloaded. </p>

<p>In this message, the user has configured the <strong>Report Completion</strong> callback URL to be: <em>http://myapp.com/reportcompletion</em></p>

<p><strong>Callback Structure in XML</strong>
The structure of the on ‘Report Completion&rsquo; callback will be as follows:</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST http://myapp.com/reportcompletion
Content-Type: application/xml

&lt;ns2:reportcompletion xmlns:ns2="http://schemas.api.whispir.com"&gt;
    &lt;reportid&gt;ABC4857BCCF484575FCA&lt;/reportid&gt;
    &lt;outputLocation&gt;http://203.116.705.600/reports&lt;/outputLocation&gt;
    &lt;timestamp&gt;09/01/13 13:22&lt;/timestamp&gt;
&lt;/ns2:reportcompletion&gt;
</code></pre>

<h3 id="sending-custom-parameters-in-callback-response">Sending custom parameters in callback response</h3>

<p>The callback API also provides a way to pass in customparameters which can be returned as is via the callback response.</p>

<p>To explain in simple scenario driven terms –</p>

<ul>
<li>App sends a POST /messages request to Whispir for sending a message to the Customer</li>
<li>App gets a location, messageID over a 202</li>
<li>Whispir Queues the request and executes it at the next execution cycle (usually immediate)</li>
<li>Customer receives the message and responds to it</li>
<li>Whispir receives the message and pushes the response to App via the callback URI</li>
<li>App needs to identify who is the customer that has responded</li>
<li>App uses the messageID provided earlier (in step 2) to cross check and identify</li>
</ul>

<p>As evident in the scenario, messageID plays a key role in identifying the message – response chain. Rather than using the Whispir provided messageID, the App can send in its own customparameters like customerID or a unique hash that corresponds to a specific transaction, or just about anything that can be a unique value in the perspective of the App. </p>

<p>Whispir shall take note of these customparameters, and when the response is returned via the callback URI, these parameters are also added to the payload. </p>

<p>This makes it easy for the App to identify the user data from the single / multiple / follow-on response of a conversation.</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST /messages
Content-Type: application/vnd.whispir.message-v1+json
{
   "to" : "0423556682",
   "subject" : "Test SMS",
   "body" : "This is the SMS",
   "callbackId" : "This is my callback",
   **"callbackParameters" : {**
      **"CustomID" : "890h0ef0fe09efw90e0jsdj0"**
   **}**
}

</code></pre>

<p>The data is provided via the ‘callbackParameters&rsquo; param and it is an array format with each data unit set in a name, value pair.
If there are more than one set of values, the data shall be sent in the following way –</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST /messages
Content-Type: application/vnd.whispir.message-v1+json

{
   "to" : "0423556682",
   "subject" : "Test SMS",
   "body" : "This is the SMS",
   "callbackId" : "This is my callback",
   **"callbackParameters" : {
      "CustomID" : "890h0ef0fe09efw90e0jsdj0",
      "CustomID2" : "9ef0fe09efw90e0jsdjsd43fw"
   }**
}

</code></pre>

<p>In the <code class="prettyprint">Response</code>, The callback shall include these passed params. Below is an example response –</p>
<pre><code class="highlight plaintext">HTTP 1.1 POST https://yourserver/callback.php
Content-Type: application/json
{
    "messageId":"ABC4857BCCF4CA",
    "location" : "https://api.whispir.com/messages/ABC4857BCCF4CA",
    "from":{
          "name":"Fred Waters",
          "mri":"Fred_Waters.528798.Sandbox@Contact.whispir.com",
          "mobile":"0430984567",
          "email":"imacros@test.com",
          "voice":"0761881564"
         },
    "responseMessage":{
           "channel":"SMS",
           "acknowledged":"09/01/13 13:22",
           "content":"Yes, I accept. Will I need to bring steel cap boots?"
    },
    **"customParamters" : [{
        "CustomID" : "890h0ef0fe09efw90e0jsdj0",
        "CustomID2" : "9ef0fe09efw90e0jsdjsd43fw"
    }]**
}
</code></pre>

<p><em>Note</em>: 
- The calling App can supply any number of custom parameters.
- The information will be passed back to the application every time a response is triggered.
- The response type will always be string, even when an integer is used.
- If no custom parameters are specified, this section will not be included in the callback JSON or XML (backwards compatibility)</p>

<h3 id="additional-information">Additional Information</h3>

<p>Reach to us directly at out <a href="https://whispir.io/contact/">contact page</a> for more help/information on this part.</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
    
  </body>
</html>
